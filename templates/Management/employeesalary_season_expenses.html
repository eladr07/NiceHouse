{% extends "./base.html" %}
{% load management_extras %}
{% block header %}
{{ block.super }}
<script>
	var selectedID = 0;
	var prev_class;
	$(document).ready(function() {
		$("#salaryTable tr").click(function() { 
			var tr = $(this);
			if (selectedID > 0)
				$("#salaryTable tr[employeeid='"+selectedID+"']").attr("class", prev_class);
			selectedID = tr.attr("employeeid");
			if (!selectedID)
				return;
			prev_class = tr.attr("class");
			tr.attr("class","selectedRow");
			//sync links
			if (selectedID > 0)
				$("#loanPay").attr("href", "/employees/" + selectedID + "/loanpay");
				$("#loanAdd").attr("href", "/employees/" + selectedID + "/addloan");
				$("#calcSalary").attr("href", "/employeesalaries/" + tr.attr("objid") + "/calc");
				$("#approve").attr("href", "/employeesalaries/" + tr.attr("objid") + "/approve");
				$("#edit").attr("href", tr.attr("objid"));
			});
		$(".fancybox").fancybox();
		$("#loanPay, #loanAdd, #edit").click(function (event) {
			if (!$(this).attr("href"))
				alert("לא נבחר עובד");
		});
		$("#approve").click(function (event) {
			event.preventDefault();
			if (!$(this).attr("href"))
				alert("לא נבחר עובד");
			$.get($(this).attr("href"), function (data) {
				if (data == 'ok')
					alert('השכר אושר !');
			});
		});
		$("#calcSalary").click(function(event) {
			if (!confirm("האם אתה בטוח שברצונך לחשב את העמלות מחדש ?"))
				event.preventDefault();
		});
	});
</script>
{% endblock header %}
{% block content %}
<div class="title">
	<div class="pageTitle">ריכוז שכר לעובד כולל הוצאות מעביד תקופתי<br>{{employee}}</div>
</div>
<div class="clearBoth"></div>
<form method="GET">
	<table class="dataTable" style="width: 70%;" border="1">
		<tr class="row1">
			<td colspan="6" style="background-color: #0065BD; color: #FFFFFF; font-weight: bold;">חיפוש</td>
		</tr>
		<tr class="row2">
			{% for field in filterForm %}
			<td>
				{{ field.label_tag }} : 
				{{ field }}
			</td>
			{% endfor %}
			<td><input type="submit" value="חפש" class="button"/></td>
		</tr>
	</table>
</form>
<br>
<div class="someIcon" style="width:100px;">
	<img src="/site_media/images/edit_48.png" width="20" height="20"  alt="החזר הלוואה" /> 
	<a id="loanAdd" class="fancybox">הלוואה חדשה</a>
</div>
<div class="someIcon" style="width:120px;">
	<img src="/site_media/images/edit_48.png" width="20" height="20"  alt="החזר הלוואה" /> 
	<a id="loanPay" class="fancybox">עדכון החזר הלוואה</a>
</div>
<div class="someIcon" style="width:170px;">
	<img src="/site_media/images/edit_48.png" width="20" height="20"  alt="שינוי" /> 
	<a id="edit" class="fancybox">שינוי מרכיבי שכר - חד פעמי</a>
</div>
<div class="someIcon"style="width:130px;">
	<img src="/site_media/images/advanced-48.png" width="20" height="20"  alt="שליחה" /> 
	<a id="calcSalary">חישוב עמלות מחדש</a>
</div>
<div class="someIcon" style="width:120px;">
	<img src="/site_media/images/edit_48.png" width="20" height="20" /> 
	<a id="approve" >אישור שכר לתשלום</a>
</div>
<div class="someIcon" style="width:100px;">
	<img src="/site_media/images/edit_48.png" width="20" height="20" /> 
	<a id="#" >תיק עובד</a>
</div>
<div class="someIcon" style="width:100px;">
	<img src="/site_media/images/print-48.png" width="20" height="20"/> 
	<a id="#" >שלח להנה"ח</a>
</div>
<div class="someIcon" style="width:100px;">
	<img src="/site_media/images/print-48.png" width="20" height="20" /> 
	<a href="/reports/employeesalary_season/{{employee.id}}/{{start.year}}/{{start.month}}/{{end.year}}/{{end.month}}" >גרסת הדפסה</a>
</div>
<div class="clearBoth"></div>
<br>
<table id="salaryTable" class="dataTable" border="1">
<caption>מציג סה"כ {{salaries|length}} משכורות</caption>
	<tr>
		<th></th>
		<th>שם העובד</th>
		<th>חודש</th>
		<th>פרוייקט</th>
		<th>סוג <BR>העסקה</th>
		<th>מס'<BR>עסקאות</th>
		<th>סה"כ<BR>שווי <BR>תלוש</th>
		<th>שווי<BR>צ'ק</th>
		<th>סה"כ<BR>ברוטו</th>
		<th>ברוטו<BR>כולל<BR>הוצאות</th>
		<th>החזר<BR>הוצאות <BR>(בנפרד)</th>
		<th>הערות</th>
		<th>ת.אישור</th>
		<th>ת.שליחה <BR>להנה"ח</th>
		<th>ת.שליחה <BR>לצ'קים</th>
	</tr>
	{% regroup salaries by employee.rank as rank_list %}
	{% for rank in rank_list %}
		<tr style="text-align:center; color:#4669D6; font-size:14px"><td colspan="15"><b>{{rank.grouper|default:"-- לא הוגדר דרג --"}}</b></td></tr>
		{% for s in rank.list %}
		{% if s.approved_date %}
			<tr class="row5" objid={{s.id}} employeeid={{s.employee.id}}>
		{% else %}
			<tr class="{% cycle 'row1' 'row2' %}" objid={{s.id}} employeeid={{s.employee.id}}>
		{% endif %}
			<td><a href="/employees/{{s.employee.id}}"><img src="/site_media/images/documentinfo-48.png" width="20" height="20" alt="פרטים" border="0" /></a></td>
			<td>{{ s.employee }}</td>
			<td>{{ s.month }}/{{ s.year }}</td>
			<td>
				{% for p in s.employee.projects.all %}
				<a href="/projects/{{p.id}}" target="_blank">{{p}}</a><br>
				{% endfor %}
			</td>
			<td>{{s.employee.employment_terms.hire_type}}</td>
			<td><a class="fancybox" href="/employee/{{s.employee.id}}/sales/{{month.year}}/{{month.month}}">{{ s.sales_count }}</a></td>
			<td><a href="{{s.get_absolute_url}}/totaldetails" class="fancybox">{{s.total_amount|commaise}}</a></td>
			<td><a href="{{s.get_absolute_url}}/checkdetails" class="fancybox">{{s.check_amount}}</a></td>
			<td>{% if s.bruto %}<a href="{{s.expenses.get_absolute_url}}" class="fancybox">{{s.bruto|commaise}}</a>{% endif %}</td>
			<td>{% if s.bruto_employer_expense %}<a href="{{s.expenses.get_absolute_url}}" class="fancybox">{{s.bruto_employer_expense|commaise}}</a>{% endif %}</td>
			<td>{% if s.refund %}{{s.refund}} - {{s.refund_type}} {% endif %}</td>
			<td>{{s.remarks|default_if_none:""}}</td>
			<td>{{s.approved_date|default_if_none:""}}</td>
			<td>{{s.sent_to_bookkeeping_date|default_if_none:""}}</td>
			<td>{{s.sent_to_checks_date|default_if_none:""}}</td>
		</tr>
		{% endfor %}
	{% endfor %}
</table>
{% endblock content %}