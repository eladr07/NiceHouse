{% extends "./base.html" %}
{% load management_extras %}
{% block header %}
{{ block.super }}
<script>
	$(document).ready(function() {
		$("#monthChange").click(function(event) {
			event.preventDefault();
			location.replace("/nhbranch/{{nhmonth.nhbranch.id}}/sales/" + $("#id_year").val() + "/" + $("#id_month").val())
		});	
		$("#monthClose").click(function(event) {
			if (!confirm("האם אתה בטוח שברצונך לסגור את החודש ?"))
				event.preventDefault();
		});		
	});
</script>
{% endblock header %}
{% block content %}
<div class="title">
	<div class="pageTitle">ריכוז עסקאות {{nhmonth.nhbranch}} לחודש {{nhmonth.month}}/{{nhmonth.year}}</div>
</div>
<div class="clearBoth"></div>
<div style="float:right;width:30%;">
	<form method="POST">
		<table class="dataTable">
			<tr class="row1">
				<td colspan="3" style="background-color: #0065BD; color: #FFFFFF; font-weight: bold;">חיפוש דרישה</td>
			</tr>
			<tr class="row2">
				{% for field in filterForm %}
				<td>
					{{ field.label_tag }} : 
					{{ field }}
				</td>
				{% endfor %}
				<td><input id="monthChange" type="button" value="חפש" class="button"/></td>
			</tr>
		</table>
	</form>
</div>
<div class="clearBoth"></div>
<div class="someIcon" style="width:100px;">
	<img src="/site_media/images/add_48.png" width="20" height="20"  alt="חדש" /> 
	<a href="/nhbranch/{{nhmonth.nhbranch.id}}/nhsale/add">הזנת עסקאות</a>
</div>
<div class="someIcon" style="width:100px">
	<img src="/site_media/images/Archive-48.png" width="20" height="20"  alt="מחיקה" /> 
	<a id="monthClose" href="/nhmonth/{{nhmonth.id}}/close">סגור חודש</a>
</div>
<div class="clearBoth"></div>	
<table id="salesTable" class="dataTable" style="text-align:center;" border="1">
<caption>מציג סה"כ {{nhmonth.nhsales.count}} עסקאות</caption>
	<tr>
		<th></th>
		<th>ת. עסקה</th>
		<th>שמות הלקוחות</th>
		<th>סוג פעולה</th>
		<th>% עמלה<br>חתום</th>
		<th>% עמלה<br>בפועל</th>
		<th>סה"כ<br>עמלה</th>
		<th>תשלום<br>לעו"ד</th>
		<th>עמלה נטו</th>
		<th>% מהכנסה<br>חודשי</th>
		<th>מס' קבלה<br>זמנית</th>
		<th>מס'<br>חשבונית</th>
		{% for nhe in nhmonth.nhbranch.nhemployees.all %}
		<th>{{nhe}}</th>
		{% endfor %}
		<th>סיכום</th>
	</tr>
    {% for s in nhmonth.nhsales.all %}
		<tr class="{% cycle 'row1' 'row2' %}" objid={{s.id}}>
			<td><a href="/nhsale/{{s.id}}">{{s.nhmonth.nhbranch.prefix}}-{{s.id}}</a></td>
			<td>{{s.sale_date|date:"j/m/y"}}</td>
			{% for ss in s.nhsaleside_set.all %}
				{% if not forloop.first %}
					<tr class="{% cycle 'row1' 'row2' %}">
						<td></td>
						<td></td>
				{% endif %}
				<td>{{ss.name1}} {{ss.name2|default_if_none:""}}</td>
				<td>{{ss.sale_type}}</td>
				<td>{{ss.signed_commission}}%</td>
				<td>{{ss.actual_commission}}%</td>
				<td>{{ss.income|commaise}}</td>
				<td>{{ss.lawyers_pay|commaise}}</td>
				<td>{{ss.net_income|commaise}}</td>
				<td></td>
				<td>{{ss.temp_receipt_num}}</td>
				<td>{{ss.invoices.all.0.num}}</td>
				{% for nhe in nhmonth.nhbranch.nhemployees.all %}
				<td>
					{% ifequal nhe ss.employee1 %}
						{{ss.employee1_pay|commaise}} ש"ח<br>{{ss.employee1_commission}}%
					{% endifequal %}
					{% ifequal nhe ss.employee2 %}
						{{ss.employee2_pay|commaise}} ש"ח<br>{{ss.employee2_commission}}%
					{% endifequal %}
					{% ifequal nhe ss.director %}
						{{ss.director_pay|commaise}} ש"ח<br>{{ss.director_commission}}%
					{% endifequal %}
				</td>
				{% endfor %}
				<td>
					{{ss.all_employee_commission|commaise}} ש"ח<br>{{ss.all_employee_commission_precentage}}%
				</td>
				{% if forloop.first %}
					</tr>
				{% endif %}
			{% endfor %}
		</tr>
	{% endfor %}
	<tr class="row3">
		<td colspan="6">סה"כ הכנסות</td>
		<td>{{total_net_income|commaise}} ש"ח</td>
		<td colspan="5"></td>
		{% for t in total_employee_pay %}
		<td>{{t|commaise}} ש"ח</td>
		<td></td>
	</tr>
</table>
{% endblock content %}